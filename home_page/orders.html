<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Order Tracking - Beha</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="home_page/css/front_page.css">
    <style>
        :root {
            --tracking-bg: #F9F5F0;
            --card-bg: #FDFBF7;
            --text-brown: #5A4A42;
            --accent-gold: #C1A661;
            --line-gray: #E0E0E0;
            --text-muted: #888;
        }

        body {
            background-color: var(--tracking-bg);
            color: var(--text-brown);
        }

        .orders-container {
            max-width: 1000px;
            margin: 4rem auto;
            padding: 0 20px;
        }

        .tracking-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .tracking-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            color: var(--text-brown);
            margin-bottom: 0.5rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .tracking-header p {
            font-family: 'Outfit', sans-serif;
            color: var(--text-brown);
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .order-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 10px 30px rgba(90, 74, 66, 0.05);
            margin-bottom: 3rem;
            border: 1px solid rgba(193, 166, 97, 0.2);
        }

        .order-id-label {
            text-align: center;
            font-family: 'Outfit', sans-serif;
            margin-bottom: 2rem;
            font-size: 1.2rem;
            color: var(--text-brown);
        }

        /* Product Section */
        .product-group {
            margin-bottom: 4rem;
        }

        .product-group:last-child {
            margin-bottom: 0;
        }

        .product-details {
            display: flex;
            gap: 2rem;
            margin-bottom: 2.5rem;
            align-items: flex-start;
        }

        .product-image {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            object-fit: cover;
            background-color: #eee;
            flex-shrink: 0;
        }

        .product-info {
            flex: 1;
            font-family: 'Outfit', sans-serif;
        }

        .info-row {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .info-label {
            font-family: 'Playfair Display', serif;
            color: var(--accent-gold);
            font-weight: 600;
            margin-right: 0.5rem;
            font-size: 1.15rem;
        }

        .info-value {
            color: var(--text-brown);
        }

        /* Timeline Section */
        .timeline-container {
            position: relative;
            padding: 0 1rem;
            margin-top: 2rem;
        }

        .timeline-track {
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 6px;
            background-color: #EAE5DD;
            border-radius: 3px;
            z-index: 1;
        }

        .timeline-progress {
            position: absolute;
            top: 15px;
            left: 0;
            height: 6px;
            background-color: var(--accent-gold);
            border-radius: 3px;
            z-index: 2;
            width: 0%;
            transition: width 1s ease;
        }

        .timeline-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 3;
        }

        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
        }

        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #FDFBF7;
            border: 3px solid #EAE5DD;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .step-circle.active {
            background-color: var(--accent-gold);
            border-color: var(--accent-gold);
        }

        .step-circle.completed {
            background-color: var(--accent-gold);
            border-color: var(--accent-gold);
        }

        .step-icon {
            color: white;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease;
        }

        .step-circle.completed .step-icon {
            opacity: 1;
            transform: scale(1);
        }

        /* Checkmark SVG styling */
        .step-icon svg {
            width: 18px;
            height: 18px;
            stroke-width: 3;
        }

        .step-label {
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            color: var(--text-brown);
            text-align: center;
            font-weight: 500;
        }

        .auth-prompt {
            text-align: center;
            padding: 4rem;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .auth-prompt h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem;
        }

        @media (max-width: 768px) {
            .tracking-header h1 {
                font-size: 2rem;
            }

            .timeline-container {
                overflow-x: auto;
                padding-bottom: 1rem;
            }

            .timeline-steps {
                min-width: 500px;
            }

            .timeline-track,
            .timeline-progress {
                min-width: 500px;
            }
        }
    </style>
</head>

<body>
    <%- include('header.html') %>

        <div class="orders-container">

            <div id="authPrompt" class="auth-prompt" style="display: none;">
                <h2>Sign in to track orders</h2>
                <p style="margin-bottom: 2rem; color: #666;">View your order history and real-time status.</p>
                <button onclick="handleSignIn()"
                    style="background: var(--text-brown); color: white; padding: 10px 30px; border-radius: 8px; border:none; cursor: pointer; font-size: 1rem;">Sign
                    In</button>

                <div style="margin-top: 2rem;">
                    <p style="color: #666; font-size: 0.9rem;">
                        Don't have an account? <a href="#" onclick="openLoginModal('signup'); return false;"
                            style="color: var(--text-brown); text-decoration: underline;">Create one</a> to track your
                        orders.
                    </p>
                </div>
            </div>

            <div id="ordersList" style="display: none;">
                <!-- Content Injected Here -->
            </div>

        </div>

        <%- include('footer.html') %>
            <%- include('../admin_panel/cart_modal.html') %>
                <%- include('login_modal.html') %>

                    <!-- Scripts -->
                    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
                    <script src="/js/supabase-init.js"></script>
                    <script src="/js/auth.js"></script>
                    <script src="js/account-popup.js"></script>
                    <script src="js/cart.js"></script>
                    <script src="js/shopbeha.js"></script>

                    <script>
                        // Timeline Steps Definition
                        const STEPS = ['Ordered', 'Verified', 'Shipping to You', 'Delivery', 'Complete'];

                        async function initOrdersPage() {
                            // 1. Check for success param & Clear Cart (Run this first, for ALL users including guests)
                            const urlParams = new URLSearchParams(window.location.search);
                            if (urlParams.get('status') === 'success') {
                                if (window.CartModule) {
                                    await window.CartModule.clearCart();
                                    console.log('Cart cleared after successful payment');
                                }
                                // Remove params from URL to avoid re-triggering on refresh
                                window.history.replaceState({}, document.title, window.location.pathname);

                                // Optional: You might want to show a specific "Thank You" message here for guests
                                // instead of the auth prompt, if they just bought something.
                            }

                            if (typeof window.supabaseClient === 'undefined') {
                                document.getElementById('authPrompt').style.display = 'block';
                                return;
                            }

                            const { data: { session } } = await window.supabaseClient.auth.getSession();

                            if (!session?.user) {
                                document.getElementById('authPrompt').style.display = 'block';
                                return;
                            }

                            // Check for orderId params
                            const orderIdArg = urlParams.get('orderId');

                            await loadOrders(session.user.id, orderIdArg);
                        }

                        async function loadOrders(userId, specificOrderId = null) {
                            document.getElementById('authPrompt').style.display = 'none';
                            document.getElementById('ordersList').style.display = 'block';
                            const ordersList = document.getElementById('ordersList');
                            ordersList.innerHTML = '<div style="text-align:center; padding: 2rem;">Loading details...</div>';

                            try {
                                let query = window.supabaseClient
                                    .from('orders')
                                    .select(`
                        id,
                        status,
                        total_amount,
                        created_at,
                        order_items (
                            quantity,
                            price,
                            product_id
                        )
                    `)
                                    .eq('user_id', userId)
                                    .neq('status', 'cancelled')
                                    .order('created_at', { ascending: false });

                                if (specificOrderId) {
                                    query = query.eq('id', specificOrderId);
                                }

                                const { data: orders, error } = await query;

                                if (error) throw error;

                                if (!orders || orders.length === 0) {
                                    ordersList.innerHTML = `
                        <div class="tracking-header">
                            <h1>No Order Found</h1>
                            <p>We couldn't find the order details.</p>
                            <br>
                            <button onclick="window.location.href='/'" style="background: var(--accent-gold); color: white; padding: 12px 30px; border:none; border-radius: 30px; cursor: pointer; font-size: 1rem; font-family: 'Outfit';">Start Shopping</button>
                        </div>
                    `;
                                    return;
                                }

                                // Helper to get product details
                                // Use the global 'products' array from shopbeha.js which matches the shop data
                                const productIds = [...new Set(orders.flatMap(o => o.order_items.map(i => i.product_id)))];
                                let productsMap = {};

                                // Try to use global products array first (from shopbeha.js)
                                if (typeof products !== 'undefined' && Array.isArray(products)) {
                                    products.forEach(p => {
                                        productsMap[p.id] = p;
                                    });
                                } else {
                                    // Fallback: Try to fetch from Supabase if global array missing (shouldn't happen)
                                    // But since we know Supabase table is missing/broken, we rely on this or placeholders.
                                    console.warn('Global products array not found, falling back to placeholders');
                                }

                                const title = specificOrderId ? 'Order Confirmed' : 'Your Order History';
                                const subtitle = specificOrderId ? 'Thank you for your purchase!' : 'Track your recent purchases';

                                ordersList.innerHTML = `
                    <div class="tracking-header">
                        <h1>${title}</h1>
                        <p>${subtitle}</p>
                         ${specificOrderId ? `<p style="margin-top:0.5rem; font-size:0.9rem;"><a href="/orders.html" style="color:var(--accent-gold); text-decoration:none;">‚Üê View All Orders</a></p>` : ''}
                    </div>
                ` + orders.map(order => renderOrderCard(order, productsMap)).join('');

                            } catch (error) {
                                console.error('Error loading orders:', error);
                                ordersList.innerHTML = '<p class="empty-state">Unable to load orders at this moment.</p>';
                            }
                        }

                        function getStepIndex(status) {
                            const s = (status || '').toLowerCase();
                            if (s === 'pending') return 0; // Ordered
                            if (s === 'paid' || s === 'processing') return 1; // Verified
                            if (s === 'shipped') return 2; // Shipping
                            if (s === 'delivered') return 3; // Delivery
                            if (s === 'completed') return 4; // Complete
                            return 0;
                        }

                        function renderOrderCard(order, productsMap) {
                            // Determine progress based on order status
                            const currentStepIdx = getStepIndex(order.status);
                            const progressPercent = (currentStepIdx / (STEPS.length - 1)) * 100;

                            // Render items
                            const itemsHtml = order.order_items.map(item => {
                                const product = productsMap[item.product_id] || { name: 'Product #' + item.product_id, image: '', description: '' };
                                const imageSrc = product.image || 'https://placehold.co/100?text=No+Img';
                                // For this design, we create a timeline PER ITEM to match the image, 
                                // even though they share the order status for now.

                                return `
                    <div class="product-group">
                        <div class="product-details">
                            <img src="${imageSrc}" alt="${product.name}" class="product-image">
                            <div class="product-info">
                                <div class="info-row">
                                    <span class="info-label">Product:</span>
                                    <span class="info-value">${product.name}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Price:</span>
                                    <span class="info-value">R ${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                                <!--<div class="info-row">
                                    <span class="info-label">Quantity:</span>
                                    <span class="info-value">${item.quantity}</span>
                                </div>-->
                            </div>
                        </div>

                        <!-- Timeline for this item -->
                        <div class="timeline-container">
                            <div class="timeline-track"></div>
                            <div class="timeline-progress" style="width: ${progressPercent}%;"></div>
                            
                            <div class="timeline-steps">
                                ${STEPS.map((step, idx) => {
                                    const isCompleted = idx <= currentStepIdx;
                                    const isActive = idx === currentStepIdx; // The current stage

                                    let circleClass = 'step-circle';
                                    if (isCompleted) circleClass += ' completed';

                                    return `
                                        <div class="timeline-step">
                                            <div class="${circleClass}">
                                                <div class="step-icon">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="20 6 9 17 4 12"></polyline>
                                                    </svg>
                                                </div>
                                            </div>
                                            <span class="step-label">${step}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                            }).join('<hr style="border:0; border-top:1px solid #EAE5DD; margin: 3rem 0;">');

                            return `
                <div class="order-card">
                    <div class="order-id-label">Order #${order.id.substring(0, 8).toUpperCase()}</div>
                    ${itemsHtml}
                </div>
            `;
                        }

                        document.addEventListener('DOMContentLoaded', () => {
                            initOrdersPage();


                        });

                        if (typeof window.supabaseClient !== 'undefined') {
                            window.supabaseClient.auth.onAuthStateChange((event) => {
                                if (event === 'SIGNED_IN') initOrdersPage();
                                if (event === 'SIGNED_OUT') location.reload();
                            });
                        }

                        function renderGuestOrder(order) {
                            document.getElementById('authPrompt').style.display = 'none';
                            const ordersList = document.getElementById('ordersList');
                            ordersList.style.display = 'block';

                            // Map products from order items (since backend includes them)
                            const productsMap = {};
                            if (order.OrderItems) { // Check capitalization from Sequelize response
                                order.OrderItems.forEach(item => {
                                    if (item.Product) {
                                        productsMap[item.product_id] = {
                                            id: item.Product.id,
                                            name: item.Product.name,
                                            image: item.Product.image_url,
                                            price: item.price
                                        };
                                    }
                                });
                            }
                            // Fallback if key is 'order_items' (underscored)
                            else if (order.order_items) {
                                order.order_items.forEach(item => {
                                    // Depending on Sequelize config, it might be item.Product or included in item structure
                                    // The order service response structure usually matches the include structure
                                    const prod = item.Product || item.product;
                                    if (prod) {
                                        productsMap[item.product_id] = {
                                            id: prod.id,
                                            name: prod.name,
                                            image: prod.image_url,
                                            price: item.price
                                        };
                                    }
                                });
                            }

                            // Use existing renderOrderCard
                            // Ensure order_items exists and is lowercase for renderOrderCard
                            if (!order.order_items && order.OrderItems) {
                                order.order_items = order.OrderItems;
                            }

                            ordersList.innerHTML = `
                                <div class="tracking-header">
                                    <h1>Order Status</h1>
                                    <p>Tracking Order #${order.id.substring(0, 8).toUpperCase()}</p>
                                    <button onclick="location.reload()" style="margin-top:1rem; background:none; border:1px solid #ccc; padding:5px 15px; border-radius:15px; cursor:pointer;">&larr; Back</button>
                                </div>
                            ` + renderOrderCard(order, productsMap);
                        }
                    </script>
</body>

</html>